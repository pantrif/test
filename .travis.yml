language: php

php:
    - 7.0

install:
    - composer install --no-dev --quiet
    - git clone https://github.com/edenhill/librdkafka.git && cd librdkafka && ./configure && make && sudo make install && cd ../
    - git clone https://github.com/arnaud-lb/php-rdkafka.git && cd php-rdkafka/ && phpize && ./configure && make && sudo make install && cd ../
    - echo "extension = rdkafka.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
    - sudo apt-get install libzookeeper-mt-dev -q
    - git clone https://github.com/andreiz/php-zookeeper.git && cd php-zookeeper && phpize && ./configure && make && sudo make install && cd ../
    - echo "extension = zookeeper.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
    
before_install:
  - sudo apt-get update
  - wget http://www.us.apache.org/dist/kafka/0.8.2.1/kafka_2.10-0.8.2.1.tgz -O kafka.tgz
  - mkdir -p kafka && tar xzf kafka.tgz -C kafka --strip-components 1
  - nohup bash -c "cd kafka && bin/zookeeper-server-start.sh config/zookeeper.properties &"
  - nohup bash -c "cd kafka && bin/kafka-server-start.sh config/server.properties &"
  - sleep 5
  - kafka/bin/kafka-topics.sh --create --partitions 1 --replication-factor 1 --topic test.1 --zookeeper localhost:2181
  - kafka/bin/kafka-topics.sh --create --partitions 4 --replication-factor 1 --topic test.4 --zookeeper localhost:2181
  - kafka/bin/kafka-topics.sh --create --partitions 64 --replication-factor 1 --topic test.64 --zookeeper localhost:2181

script:
  - phpunit -c phpunit.xml --coverage-text
